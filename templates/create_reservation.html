@main_bp.route('/reservation/new', methods=['GET', 'POST'])
@main_bp.route('/reservation/create', methods=['GET', 'POST'])
def create_reservation():
    current_app.logger.debug("→ [create_reservation] Método: %s", request.method)
    form = ReservaForm()

    if form.is_submitted():
        current_app.logger.debug("   [create_reservation] request.form: %s", dict(request.form))
        current_app.logger.debug("   [create_reservation] form.errors previos: %s", form.errors)

    if form.validate_on_submit():
        current_app.logger.debug("   [create_reservation] Form validado, creando Reserva…")

        # Aplicar descuento promocional si corresponde
        descuento = 0.0
        if form.codigo_promocional.data:
            codigo = CodigoPromocional.query.filter_by(
                codigo=form.codigo_promocional.data.upper()
            ).first()
            if codigo and codigo.is_valid():
                descuento = codigo.calcular_descuento(form.precio_total.data)
                codigo.usos_actuales += 1
                db.session.commit()
                current_app.logger.debug("   [create_reservation] Descuento aplicado: %s", descuento)

        # Crear la reserva
        reserva = Reserva(
            cliente=form.cliente.data,
            email_cliente=form.email_cliente.data,
            telefono_cliente=form.telefono_cliente.data,
            barco=form.barco.data,
            fecha_checkin=form.fecha_checkin.data,
            fecha_checkout=form.fecha_checkout.data,
            hora_inicio=form.hora_inicio.data,
            hora_finalizacion=form.hora_finalizacion.data,
            precio_total=form.precio_total.data,
            pago_a=form.pago_a.data or 0,
            pago_b=form.pago_b.data or 0,
            apa=form.apa.data or 0,
            codigo_promocional=(
                form.codigo_promocional.data.upper()
                if form.codigo_promocional.data else None
            ),
            descuento=descuento,
            extras=form.extras.data,
            extras_facturados=form.extras_facturados.data or 0,
            observaciones=form.observaciones.data
        )
        db.session.add(reserva)
        db.session.commit()
        current_app.logger.debug("   [create_reservation] ✓ Reserva guardada con ID %s", reserva.id)

        flash('Reserva creada exitosamente', 'success')
        return redirect(url_for('main.reservations'))

    # Si GET o validación falla, renderizar formulario
    return render_template('create_reservation.html', form=form)